generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- Tabelas administrativas / domínio ---

model Operador {
  id       String   @id @default(uuid())
  usuario  String   @unique
  senha    String
  criadoEm DateTime @default(now()) @map("createdAt")
}

model Frota {
  id           String        @id @default(uuid())
  criadoEm     DateTime      @default(now()) @map("createdAt")
  dispositivos Dispositivo[]
  vendas       Venda[]
}

model Venda {
  id      String   @id @default(uuid())
  frotaId String
  frota   Frota    @relation(fields: [frotaId], references: [id])
  valor   Float
  data    DateTime @default(now())
}

model Dispositivo {
  id       String   @id @default(uuid())
  ip       String
  criadoEm DateTime @default(now()) @map("createdAt")
  frotaId  String
  frota    Frota    @relation(fields: [frotaId], references: [id])
}

// --- Pagamentos / Sessões ---

model Pagamento {
  id        String  @id @default(cuid())
  valor     Float
  descricao String
  chavePix  String? // opcional
  payload   String? // opcional (QR/payload do Pix)
  status    String  @default("pendente") // 'pendente' | 'pago' | 'expirado'
  plano     String

  // para casar com as rotas de API:
  ip       String?
  mac      String?
  roteador String?

  // (legado, se quiser manter compatibilidade com código antigo)
  // ipCliente   String?
  // macCliente  String?

  criadoEm DateTime  @default(now())
  pagoEm   DateTime?
  expiraEm DateTime?

  // relação com SessaoAtiva (invertida)
  sessoes SessaoAtiva[]

  // Se seu PSP te fornecer um identificador único (txid/e2eid), vale manter único:
  // txid     String? @unique

  @@index([descricao, valor, status])
  @@index([mac])
  @@index([criadoEm])
  @@map("pagamentos")
}

model SessaoAtiva {
  id         String   @id @default(cuid())
  ipCliente  String   @unique
  macCliente String?
  plano      String
  inicioEm   DateTime @default(now())
  expiraEm   DateTime
  ativo      Boolean  @default(true)

  pagamentoId String?
  pagamento   Pagamento? @relation(fields: [pagamentoId], references: [id], onDelete: SetNull)

  @@map("sessoes_ativas")
}
enum Status {
  PENDENTE
  PAGO
  EXPIRADO
  CANCELADO
}

model Transacao {
  id        String   @id @default(cuid())
  txid      String   @unique
  valor     Decimal  @db.Decimal(10, 2)
  descricao String
  status    Status   @default(PENDENTE)
  mac       String?
  ip        String?
  minutos   Int?     @default(120)
  linkOrig  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  paidAt    DateTime?
}
