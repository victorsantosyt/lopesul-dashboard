generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Operador {
  role     String?

  id       String   @id @default(uuid())
  nome     String   @unique @map("usuario")
  senha    String
  ativo    Boolean  @default(true)
  criadoEm DateTime @default(now()) @map("createdAt")

  @@map("operadores")
}

// Status da frota (ônibus)
enum FrotaStatus {
  ATIVO
  INATIVO
  MANUTENCAO
}

// Status técnico de roteadores / túneis
enum RoteadorStatus {
  DESCONHECIDO
  ONLINE
  OFFLINE
  ERRO
}

model Frota {
  id           String        @id @default(uuid())
  criadoEm     DateTime      @default(now()) @map("createdAt")
  nome         String?       // nome legado/opcional

  // Campos de negócio da frota
  placa        String?
  rotaLinha    String?
  status       FrotaStatus   @default(ATIVO)
  observacoes  String?

  // Relacionamento opcional com Roteador (1 frota -> 1 roteador)
  roteadorId   String?       @unique
  roteador     Roteador?     @relation(fields: [roteadorId], references: [id])

  dispositivos Dispositivo[]
  vendas       Venda[]

  @@index([criadoEm])
}

model Venda {
  id        String   @id @default(uuid())
  frotaId   String
  data      DateTime @default(now())
  valorCent Int
  frota     Frota    @relation(fields: [frotaId], references: [id], onDelete: Cascade)

  @@index([frotaId, data])
}

model Dispositivo {
  id           String   @id @default(uuid())
  criadoEm     DateTime @default(now()) @map("createdAt")
  frotaId      String
  atualizadoEm DateTime @updatedAt
  ip           String   @db.Inet
  frota        Frota    @relation(fields: [frotaId], references: [id], onDelete: Cascade)
  mikId        String?  @unique
  mikrotikHost String?
  mikrotikUser String?
  mikrotikPass String?
  mikrotikPort Int      @default(8728)
  mikrotikUseSsl Boolean @default(false)
  pedidos      Pedido[]

  @@unique([frotaId, ip])
  @@index([ip])
}

// Novo modelo para Mikrotiks / roteadores
model Roteador {
  id        String   @id @default(cuid())
  nome      String   // ex: "Router Bus 1" ou "Onibus_101"
  ipLan     String   // ex: "10.200.200.2" ou "192.168.88.1"
  usuario   String   // usuário API/SSH (ex: admin)
  senhaHash String   // senha criptografada

  portaApi  Int      @default(8728)
  portaSsh  Int      @default(22)

  // Dados de WireGuard (lado Mikrotik)
  wgPublicKey String? // chave pública do Mikrotik
  wgIp        String? // ex: "10.200.200.2/32"

  statusMikrotik  RoteadorStatus @default(DESCONHECIDO)
  statusWireguard RoteadorStatus @default(DESCONHECIDO)

  // Relacionamento opcional com Frota (1 roteador -> 1 frota)
  frota    Frota?
  sessoes  SessaoAtiva[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SessaoAtiva {
  id         String   @id @default(cuid())
  ipCliente  String   @unique
  macCliente String?
  plano      String
  inicioEm   DateTime @default(now())
  expiraEm   DateTime
  ativo      Boolean  @default(true)

  pedidoId   String?
  pedido     Pedido?  @relation(fields: [pedidoId], references: [id])
  roteadorId String?

  roteadorId String?
  roteador   Roteador? @relation(fields: [roteadorId], references: [id])

  @@index([ativo])
  @@index([pedidoId])
  @@index([roteadorId])
  @@map("sessoes_ativas")
}

model Config {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model Pedido {
  id            String        @id @default(cuid())
  code          String        @unique
  amount        Int
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  description   String?
  deviceMac     String?
  ip            String?       @db.Inet
  busId         String?
  customerName  String?
  customerEmail String?
  customerDoc   String?
  metadata      Json?
  processedAt   DateTime?     // Worker automation
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  charges       Charge[]
  SessaoAtiva   SessaoAtiva[]
  deviceId      String?
  deviceIdentifier String?
  device        Dispositivo?  @relation(fields: [deviceId], references: [id])

  @@index([status, createdAt])
  @@index([method, createdAt])
  @@index([status, processedAt])
  @@index([deviceId])
}

model Charge {
  id         String        @id @default(cuid())
  pedidoId   String
  providerId String?
  status     ChargeStatus  @default(CREATED)
  method     PaymentMethod
  qrCode     String?
  qrCodeUrl  String?
  raw        Json?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  pedido     Pedido        @relation(fields: [pedidoId], references: [id], onDelete: Cascade)

  @@index([pedidoId])
  @@index([status, createdAt])
  @@index([providerId])
}

model WebhookLog {
  id        String   @id @default(cuid())
  event     String?
  orderCode String?
  payload   Json?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([event])
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELED
  EXPIRED
}

enum PaymentMethod {
  PIX
  CARD
  BOLETO
}

enum ChargeStatus {
  CREATED
  AUTHORIZED
  PAID
  REFUNDED
  FAILED
  CANCELED
}
