// prisma/schema.prisma

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////////////////////////
//  Autenticação / Operadores
////////////////////////////////////////

model Operador {
  id       String   @id @default(uuid())
  // Login case-insensitive e único (requer extensão CITEXT)
  nome     String   @unique @db.Citext @map("usuario")
  // Hash de senha (argon2/bcrypt). 128 cobre atual e futuro com folga
  senha    String   @db.VarChar(128)
  ativo    Boolean  @default(true)
  criadoEm DateTime @default(now()) @map("createdAt")

  @@map("operadores")
  @@index([ativo])
}

////////////////////////////////////////
//  Frota / Dispositivos / Vendas
////////////////////////////////////////

model Frota {
  id           String        @id @default(uuid())
  criadoEm     DateTime      @default(now()) @map("createdAt")
  nome         String?       @db.VarChar(140)
  dispositivos Dispositivo[]
  vendas       Venda[]

  @@index([criadoEm])
}

model Venda {
  id        String   @id @default(uuid())
  frotaId   String
  valorCent Int
  data      DateTime @default(now())
  frota     Frota    @relation(fields: [frotaId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // consultas por frota ordenadas por data
  @@index([frotaId, data])
}

model Dispositivo {
  id           String   @id @default(uuid())
  ip           String   @db.Inet        // IPv4/IPv6 validado no Postgres
  criadoEm     DateTime @default(now()) @map("createdAt")
  atualizadoEm DateTime @updatedAt
  frotaId      String
  frota        Frota    @relation(fields: [frotaId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // impede IP duplicado dentro da MESMA frota
  @@unique([frotaId, ip])
  @@index([ip])
}

////////////////////////////////////////
//  Sessões (captive)
////////////////////////////////////////

model SessaoAtiva {
  id         String   @id @default(cuid())
  ipCliente  String   @unique @db.Inet
  macCliente String?  @db.VarChar(17)
  plano      String   @db.VarChar(64)
  inicioEm   DateTime @default(now())
  expiraEm   DateTime
  ativo      Boolean  @default(true)

  // relacionamento com Pedido (opcional)
  pedidoId String?
  pedido   Pedido? @relation(fields: [pedidoId], references: [id], onDelete: SetNull)

  @@index([ativo])
  @@index([pedidoId])
  @@map("sessoes_ativas")
}

////////////////////////////////////////
//  Configurações
////////////////////////////////////////

model Config {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

////////////////////////////////////////
//  Integração Pagar.me
////////////////////////////////////////

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  CANCELED
  EXPIRED
}

enum PaymentMethod {
  PIX
  CARD
  BOLETO
}

enum ChargeStatus {
  CREATED
  AUTHORIZED
  PAID
  REFUNDED
  FAILED
  CANCELED
}

model Pedido {
  id            String        @id @default(cuid())
  code          String        @unique
  amount        Int
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  description   String?       @db.VarChar(140)
  deviceMac     String?       @db.VarChar(17)
  ip            String?       @db.Inet
  busId         String?       @db.VarChar(64)
  customerName  String?       @db.VarChar(140)
  customerEmail String?       @db.Citext
  customerDoc   String?       @db.VarChar(14) // CPF/CNPJ sem máscara
  metadata      Json?
  charges       Charge[]
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  SessaoAtiva   SessaoAtiva[]

  @@index([status, createdAt])
  @@index([method, createdAt])
  @@index([busId, createdAt])
}

model Charge {
  id         String        @id @default(cuid())
  pedidoId   String
  pedido     Pedido        @relation(fields: [pedidoId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  providerId String?       @db.VarChar(64)  // id da charge no Pagar.me
  status     ChargeStatus  @default(CREATED)
  method     PaymentMethod
  qrCode     String?       @db.Text         // Pix copia-e-cola (pode ser longo)
  qrCodeUrl  String?       @db.Text         // URL da imagem (pode ser longa)
  raw        Json?                         // mantemos somente no DB; não expor via API
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt

  @@index([pedidoId])
  @@index([status, createdAt])
  @@index([providerId])
}

model WebhookLog {
  id        String   @id @default(cuid())
  event     String?  @db.VarChar(64)
  orderCode String?  @db.VarChar(64)
  payload   Json?
  createdAt DateTime @default(now())

  @@index([createdAt])
  @@index([event])
}
